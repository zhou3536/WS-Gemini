<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑预览</title>
    <style>
        /* --- 基本样式重置与布局 --- */
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: sans-serif;
            overflow-x: auto;
            min-width: 1000px;
        }

        /* --- 主容器：使用Flexbox创建左右布局 --- */
        .container {
            display: flex;
            height: 100%;
        }

        /* --- 左右两个面板的通用样式 --- */
        .pane1,
        .pane2 {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .pane1 {
            flex: 1;
        }

        .pane2 {
            flex: 1;
        }

        .pane1>p {
            text-align: center;
            color: #ff0000a7;
            font-weight: 600;
            font-size: 16px;
        }

        /* --- 编辑器面板 --- */
        .editor-pane {
            background-color: #282a36;
        }

        #editor {
            width: 100%;
            flex-grow: 1;
            font-size: 16px;
        }

        /* Ace Editor 的光标有时会因布局问题错位，以下样式可修复 */
        #editor .ace_gutter {
            z-index: 1;
        }

        /* --- 控制栏 --- */
        .controls {
            padding: 6px 25px;
            border-top: 1px solid #000000;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
        }

        .controls button {
            width: 100%;
            padding: 8px 20px;
            background-color: #226224;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #1a9020;
        }

        .preview-pane {
            border-left: 2px solid #ccc;
            background-color: #fff;
        }

        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #fff;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;

        }

        ::-webkit-scrollbar-thumb {
            background: #2e9ae392;

        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0064a2ee;
        }

        .ace-monokai {
            background-color: #282a36;
        }

        .ace-monokai .ace_gutter {
            background-color: #282a36;
        }

        .divider {
            width: 4px;
            background: #ccc;
            cursor: ew-resize;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .divider:hover {
            background: #999;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 0;
            left: -8px;
            right: -8px;
            bottom: 0;
            background: transparent;
        }

        /* 拖拽时的样式 */
        .dragging {
            cursor: ew-resize !important;
            user-select: none !important;
        }

        .dragging * {
            pointer-events: none !important;
        }
    </style>
</head>

<body>

    <div class="container" id="container">
        <div class="pane1 editor-pane" id="pane1">
            <div id="editor"></div>
            <p>如果网页显示不正常，尝试使用浏览器预览功能</p>
            <div class="controls">
                <button id="run-button-newwindow">浏览器预览</button>
                <button id="run-button">窗口预览</button>
            </div>
        </div>
        <div class="divider" id="divider"></div>
        <div class="pane2 preview-pane" id="pane2">
            <iframe id="preview-frame" title="代码预览"></iframe>
        </div>
    </div>

    <!-- 引入 Ace Editor 核心库和扩展 -->
    <!-- 核心库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
    <!-- 语言工具扩展，用于自动补全 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ext-language_tools.js"></script>

    <script>
        // 1. 初始化 Ace Editor
        // -----------------------------------------------------------------
        const editor = ace.edit("editor");

        // 设置主题 (例如：monokai, chrome, github, solarized_dark)
        editor.setTheme("ace/theme/monokai");

        // 设置语言模式为 HTML (也支持 css, javascript)
        editor.session.setMode("ace/mode/html");

        // 设置编辑器选项
        editor.setOptions({
            fontSize: "14px",                 // 字体大小
            enableBasicAutocompletion: true,  // 启用基本自动补全
            enableLiveAutocompletion: true,   // 启用实时自动补全 (需要 ext-language_tools.js)
            enableSnippets: true,             // 启用代码片段
            showPrintMargin: false,           // 不显示打印边距线
            // wrap: true,                       // 自动换行
        });


        // 2. 设置编辑器初始代码内容
        const params = new URLSearchParams(window.location.search);
        const codekey = params.get('code');
        const CACHE_KEY = codekey || 'previewcode';
        const savedCode = localStorage.getItem(CACHE_KEY);

        const initialCode = savedCode || `<h1>Hello World</h1>`;

        editor.setValue(initialCode, -1);


        // 3. 实现预览功能
        // -----------------------------------------------------------------
        const runButton = document.getElementById('run-button');
        const runButtonNW = document.getElementById('run-button-newwindow');
        const previewFrame = document.getElementById('preview-frame');

        // 更新预览区域的函数
        function updatePreview() {
            // 从 Ace Editor 获取当前全部代码
            const code = editor.getValue();
            localStorage.setItem(CACHE_KEY, code);

            // 将代码内容赋值给 iframe 的 srcdoc 属性
            // 这是最安全、最直接的渲染方式，可以有效隔离主页面和预览页面的环境
            previewFrame.srcdoc = code;
        }
        updatePreview();
        function NewPreview() {
            const code = editor.getValue();
            localStorage.setItem(CACHE_KEY, code);
            // 1. 创建一个 Blob 对象，类型 'text/html'
            const blob = new Blob([code], { type: 'text/html' });
            // 2. 创建一个临时的 URL
            const url = URL.createObjectURL(blob);
            // 3. 打开新标签页并导航到这个 URL
            window.open(url, '_blank');
        }

        // 为"运行"按钮添加点击事件监听
        runButton.addEventListener('click', updatePreview);
        runButtonNW.addEventListener('click', NewPreview);

        // 4. 拖拽分割线功能
        (function () {
            console.log("这个匿名函数在页面加载时只执行一次！");
            const divider = document.getElementById('divider');
            const leftPanel = document.getElementById('pane1');
            const rightPanel = document.getElementById('pane2');
            const container = document.getElementById('container');

            let isDragging = false;
            let startX = 0;
            let startLeftWidth = 0;
            let startRightWidth = 0;

            // 开始拖拽
            divider.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;

                // 记录开始时的面板宽度
                const containerRect = container.getBoundingClientRect();
                startLeftWidth = leftPanel.getBoundingClientRect().width;
                startRightWidth = rightPanel.getBoundingClientRect().width;

                // 添加拖拽样式，防止鼠标事件被其他元素捕获
                document.body.classList.add('dragging');

                // 阻止默认行为和事件冒泡
                e.preventDefault();
                e.stopPropagation();
            });

            // 拖拽移动
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                // 计算鼠标移动的距离
                const deltaX = e.clientX - startX;

                // 计算新的面板宽度
                const newLeftWidth = startLeftWidth + deltaX;
                const newRightWidth = startRightWidth - deltaX;

                // 设置最小宽度限制
                if (newLeftWidth < 400 || newRightWidth < 360) return;

                // 更新面板宽度
                leftPanel.style.flex = `0 0 ${newLeftWidth}px`;
                rightPanel.style.flex = `0 0 ${newRightWidth}px`;

                // 阻止默认行为
                e.preventDefault();
            });

            // 结束拖拽
            document.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;

                    // 移除拖拽样式
                    document.body.classList.remove('dragging');

                    // 阻止默认行为
                    e.preventDefault();
                }
            });

            // 处理鼠标离开窗口的情况
            document.addEventListener('mouseleave', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.classList.remove('dragging');
                }
            });

            // 键盘事件：按下 ESC 键取消拖拽
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isDragging) {
                    isDragging = false;
                    document.body.classList.remove('dragging');

                    // 恢复到开始拖拽时的状态
                    leftPanel.style.flex = `0 0 ${startLeftWidth}px`;
                    rightPanel.style.flex = `0 0 ${startRightWidth}px`;
                }
            });

        })();
    </script>
</body>

</html>