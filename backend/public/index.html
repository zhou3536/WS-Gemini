<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="md.css">
    <link rel="stylesheet" href="color.css">
    <script src="highlight.min.js"></script>
    <script src="marked.min.js"></script>
    <!-- <link rel="manifest" href="/manifest.json"> -->
</head>

<body>

    <div class="nav">
        <!-- 模型选择 -->
        <select id="gemini-v" class="send-btn1">
            <option value="gemini-2.5-flash-lite-preview-06-17">Gemini-2.5-F-Lite</option>
            <option value="gemini-2.5-flash">Gemini-2.5-Flash</option>
            <option value="gemini-2.5-pro">Gemini-2.5-Pro</option>
        </select>
        <div class="btnbox">
            <button class="theme-toggle" id="themeToggle"></button>
        </div>
    </div>
    <div class="container">
        <ul id="history-list" class="list-1">历史记录</ul>
        <main class="chat-area" id="chat-area">
            <div id="welcome">探索无界限</div>
            <div id="chat-window"></div>
            <div id="input-area" class="input-area">
                <div id="file-preview-area" class="file-preview-area"></div>
                <textarea id="prompt-input" placeholder="问题总会有答案..." rows="1"></textarea>
                <input type="file" id="file-input" multiple style="display: none;">
                <div class="send-box">
                    <div class="menu">
                        <button id="new-chat-btn">新建对话</button>
                        <button id="addfile"></button>
                        <button id="Search" class="search">联网搜索</button>
                        <button id="send-btn" class="send-btn"></button>
                    </div>
                </div>
            </div>
        </main>
        <img src="" alt="">
        <p></p>
    </div>
    <script>
        let selectedFiles = []; // 用于存储选择的文件
        let SearchOn = false;   // 搜索开关
        const welcome = document.getElementById('welcome');
        const inputarea = document.getElementById('input-area');
        const Searchbtn = document.getElementById('Search');
        const chatWindow = document.getElementById('chat-window');
        const sendBtn = document.getElementById('send-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const chatarea = document.getElementById('chat-area');
        const promptInput = document.getElementById('prompt-input');
        const addFileBtn = document.getElementById('addfile');
        const fileInput = document.getElementById('file-input');
        const filePreviewArea = document.getElementById('file-preview-area');
        const ws = new WebSocket(`ws://${window.location.host}`);

        let sessionId = localStorage.getItem('sessionId');
        let currentModelResponseElement = null; // 用于追踪当前模型响应的DOM元素
        let accumulatedStreamText = ''; // 用于存储流式响应的原始文本


        // --- WebSocket 事件处理 ---
        ws.onopen = () => {
            console.log('WebSocket连接已建立');
            if (sessionId) {
                ws.send(JSON.stringify({ type: 'loadHistory', sessionId }));
            } else {
                welcome.style.display = 'block';
            }
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            switch (data.type) {

                case 'sessionCreated':
                    sessionId = data.sessionId;
                    localStorage.setItem('sessionId', sessionId);
                    break;
                case 'historyLoaded':
                    renderHistory(data.history);
                    break;
                case 'historiesListed':
                    renderHistoriesList(data.list);
                    break;
                case 'userMessageEcho':
                    appendMessage(data.prompt, 'user');
                    break;
                case 'streamChunk':
                    appendStreamChunk(data.chunk);
                    break;
                case 'streamEnd':
                    currentModelResponseElement = null;
                    hljs.highlightAll();
                    break;
                case 'error':
                    console.error('服务器错误:', data.message);
                    alert(`发生错误: ${data.message}`);
                    break;
            }
        };

        ws.onclose = () => {
            console.log('WebSocket连接已关闭');
            // 可以在这里尝试重连
        };

        ws.onerror = (error) => {
            console.error('WebSocket 错误:', error);
        };

        // --- UI渲染函数 ---
        function renderHistory(history) {
            welcome.style.display = 'none';
            chatWindow.innerHTML = '';
            history.forEach(message => {
                if (message.role === 'user') {
                    appendMessage(message.parts[0].text, 'user');
                } else if (message.role === 'model') {
                    appendMessage(message.parts[0].text, 'model');
                }
            });
            hljs.highlightAll();
        }

        function renderHistoriesList(list) {
            historyList.innerHTML = ''; // 清空现有列表
            list.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.title;
                li.dataset.sessionId = item.sessionId;
                if (item.sessionId === sessionId) {
                    li.classList.add('active');
                }
                li.addEventListener('click', () => {
                    if (sessionId !== item.sessionId) {
                        sessionId = item.sessionId;
                        localStorage.setItem('sessionId', sessionId);
                        ws.send(JSON.stringify({ type: 'loadHistory', sessionId }));
                        // 更新列表的激活状态
                        document.querySelectorAll('#history-list li').forEach(el => el.classList.remove('active'));
                        li.classList.add('active');
                    }
                });
                historyList.appendChild(li);
            });
        }

        function appendMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-box');
            const sendinfo = document.createElement('div');
            sendinfo.classList.add(`sender`);
            // sendinfo.innerHTML = `<img src="img/${sender}.png" alt=""><p>${sender}</p>`;
            if (sender === 'user') {
                sendinfo.innerHTML = '<img src="img/user.png" alt=""><p>User</p>'
            } else {
                sendinfo.innerHTML = '<img src="img/model.png" alt=""><p>Gemini</p>'
            };
            const message = document.createElement('div');
            message.innerHTML = marked.parse(text);
            message.classList.add(`${sender}-message`, 'message');
            // pre.appendChild(code);
            messageElement.appendChild(sendinfo);
            messageElement.appendChild(message);


            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageElement; // 返回创建的元素以便流式追加
        }

        function appendStreamChunk(chunk) {
            if (!currentModelResponseElement) {
                // 如果是流的开始，创建一个新的消息元素
                const messageElement = document.createElement('div');
                messageElement.classList.add('message-box');
                const sendinfo = document.createElement('div');
                sendinfo.classList.add('sender-model', 'message');
                const message = document.createElement('div');
                message.classList.add('model-message');
                messageElement.appendChild(sendinfo);
                messageElement.appendChild(message);
                chatWindow.appendChild(messageElement);
                currentModelResponseElement = message;
                accumulatedStreamText = '';
            }
            // 将新的原始块附加到累积文本中
            accumulatedStreamText += chunk;
            currentModelResponseElement.innerHTML = marked.parse(accumulatedStreamText);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- 发送消息 ---
        sendBtn.addEventListener('click', sendMessage);
        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const prompt = promptInput.value.trim();
            if (prompt === '' && selectedFiles.length === 0) return;

            welcome.style.display = 'none';


            const filePromises = selectedFiles.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve({
                            data: e.target.result.split(',')[1], // Base64 data
                            mimeType: file.type
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });

            const files = await Promise.all(filePromises);
            const model = document.getElementById('gemini-v').value;

            ws.send(JSON.stringify({
                type: 'newMessage',
                sessionId,
                prompt,
                files,
                model,
                useWebSearch: SearchOn
            }));

            promptInput.value = '';
            selectedFiles = [];
            renderFilePreviews();
            promptInput.focus();
        }

        // --- 新建对话 ---
        newChatBtn.addEventListener('click', () => {
            sessionId = null;
            localStorage.removeItem('sessionId');
            chatWindow.innerHTML = '';
            welcome.style.display = 'block';
            document.querySelectorAll('#history-list li').forEach(el => el.classList.remove('active'));
        });


    </script>
    <script src="script.js"></script>
    <script src="theme.js"></script>


</body>

</html>