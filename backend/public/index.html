<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGemini</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="md.css">
    <link rel="stylesheet" href="color.css">
    <script src="highlight.min.js"></script>
    <script src="marked.min.js"></script>
    <!-- <link rel="manifest" href="/manifest.json"> -->
</head>

<body>

    <div class="nav">
        <button class="hisbtn" id="history-b"></button>
        <!-- 模型选择 -->
        <select id="gemini-v" class="send-btn1">
            <option value="gemini-2.5-flash-lite-preview-06-17">Gemini-2.5-F-Lite</option>
            <option value="gemini-2.5-flash">Gemini-2.5-Flash</option>
            <option value="gemini-2.5-pro">Gemini-2.5-Pro</option>
        </select>
        <div class="btnbox">
            <button class="dhdhbtn" onclick="opendhdh()"></button>
            <button class="theme-toggle" id="themeToggle"></button>
        </div>
    </div>
    <div class="container">
        <ul id="history-list" class="list-1">历史记录</ul>
        <ul id="list-dhdh" class="list-1"></ul>
        <main class="chat-area" id="chat-area">
            <div id="welcome">探索无界限</div>
            <div id="chat-window"></div>
            <div id="input-area" class="input-area">
                <div id="file-preview-area" class="file-preview-area"></div>
                <textarea id="prompt-input" placeholder="问题总会有答案..." rows="1"></textarea>
                <input type="file" id="file-input" multiple style="display: none;">
                <div class="send-box">
                    <div class="menu">
                        <button id="new-chat-btn">新建对话</button>
                        <button id="addfile"></button>
                        <button id="Search" class="search">联网搜索</button>
                        <div id="Connection" style="width: 10px; height: 10px; border-radius: 15px;" title="连接状态"></div>
                        <button id="send-btn" class="send-btn"></button>
                    </div>
                </div>
            </div>
        </main>
        <img src="" alt="">
        <p></p>
    </div>
    <div id="delhistory"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>

        const welcome = document.getElementById('welcome');
        const inputarea = document.getElementById('input-area');
        const Searchbtn = document.getElementById('Search');
        const chatWindow = document.getElementById('chat-window');
        const sendBtn = document.getElementById('send-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const chatarea = document.getElementById('chat-area');
        const promptInput = document.getElementById('prompt-input');
        const addFileBtn = document.getElementById('addfile');
        const fileInput = document.getElementById('file-input');
        const filePreviewArea = document.getElementById('file-preview-area');
        const Connection = document.getElementById('Connection');
        const delhistorybox = document.getElementById('delhistory');
        const socket = io();
        let sessionId = localStorage.getItem('sessionId');
        let currentModelResponseElement = null; // 用于追踪当前模型响应的DOM元素
        let accumulatedStreamText = ''; // 用于存储流式响应的原始文本
        let sendinfobox = null;
        let modelmessage = null;
        let selectedFiles = []; // 用于存储选择的文件
        let SearchOn = false;   // 搜索开关

        // --- Socket.IO 事件处理 ---
        socket.on('connect', () => {
            console.log('Socket.IO连接已建立');
            Connection.style.background = 'green';
            sendBtn.disabled = false;
            if (sessionId) {
                socket.emit('loadHistory', { sessionId });
            } else {
                welcome.style.display = 'block';
            }
        });

        socket.on('sessionCreated', (data) => {
            sessionId = data.sessionId;
            localStorage.setItem('sessionId', sessionId);
        });
        socket.on('historyLoaded', (data) => {
            renderHistory(data.history);
        });
        socket.on('historiesListed', (data) => {
            renderHistoriesList(data.list);
            delHistories(data.list);
        });
        socket.on('userMessageEcho', (data) => {
            appendMessage(data.prompt, 'user', data.fileCount);
            createmodelmessagebox();
        });
        socket.on('streamChunk', (data) => {
            appendStreamChunk(data.chunk);
        });
        socket.on('streamEnd', () => {
            currentModelResponseElement = null;
            sendBtn.disabled = false;
            if (sendinfobox) sendinfobox.classList.remove('loading');
            hljs.highlightAll();
            addcopy();
        });
        socket.on('nothistory', (data) => {
            console.error(data.message);
            newChatBtn.click();
        });
        socket.on('APIerror', (data) => {
            console.error('API错误:', data.message);
            if (sendinfobox) sendinfobox.classList.remove('loading');
            sendBtn.disabled = false;
            appenderror(data.message);
        });
        socket.on('error', (data) => {
            console.error('服务器错误:', data.message);
            alert(`发生错误: ${data.message}`);
        });


        socket.on('disconnect', () => {
            console.log('Socket.IO连接已关闭');
            Connection.style.background = 'red';
            sendBtn.disabled = true;
        });

        // --- UI渲染函数 ---
        function renderHistory(history) {
            welcome.style.display = 'none';
            chatWindow.innerHTML = '';
            history.forEach(message => {
                if (message.role === 'user') {
                    const fileCount = message.parts.length > 1 ? message.parts.length - 1 : 0;
                    appendMessage(message.parts[0].text, 'user', fileCount);
                } else if (message.role === 'model') {
                    appendMessage(message.parts[0].text, 'model');
                }
            });
            addcopy();
            hljs.highlightAll();
        }

        function renderHistoriesList(list) {
            historyList.innerHTML = '';
            const ophis = document.createElement('h4');
            ophis.innerText = '管理记录';
            ophis.addEventListener('click', function () { delhistorybox.style.display = 'block' });
            historyList.appendChild(ophis);
            list.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.title;
                li.dataset.sessionId = item.sessionId;
                if (item.sessionId === sessionId) {
                    li.classList.add('active');
                }
                li.addEventListener('click', (e) => {
                    if (sessionId !== item.sessionId) {
                        sessionId = item.sessionId;
                        localStorage.setItem('sessionId', sessionId);
                        socket.emit('loadHistory', { sessionId });
                        closehislist();
                        chatWindow.innerHTML = '';
                        // 更新列表的激活状态
                        document.querySelectorAll('#history-list li').forEach(el => el.classList.remove('active'));
                        li.classList.add('active');
                    }
                });

                historyList.appendChild(li);
            });
        }

        function appendMessage(text, sender, fileCount = 0) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-box');
            const sendinfo = document.createElement('div');
            sendinfo.classList.add('sender');
            const message = document.createElement('div');
            message.classList.add(`${sender}-message`, 'message');

            if (sender === 'user') {
                sendinfo.innerHTML = '<img src="img/user.png" alt=""><p class="user">User</p>';
                const messagep = document.createElement('p');
                messagep.innerText = text;
                message.appendChild(messagep);
            } else {
                sendinfo.innerHTML = '<img src="img/model.png" alt=""><p>Gemini</p>';
                message.innerHTML = marked.parse(text);
            };

            if (fileCount > 0) {
                const fileCountElement = document.createElement('i');
                fileCountElement.classList.add('fileCount');
                fileCountElement.textContent = `+${fileCount} 个文件`;
                message.appendChild(fileCountElement);
            }

            messageElement.appendChild(sendinfo);
            messageElement.appendChild(message);


            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            // return messageElement; 
        }

        function createmodelmessagebox() {
            const messagebox = document.createElement('div');
            messagebox.classList.add('message-box');
            const sendinfo = document.createElement('div');
            sendinfo.classList.add('sender', 'loading');
            sendinfo.innerHTML = '<img src="img/model.png" alt=""><p>Gemini</p>';
            const message = document.createElement('div');
            message.classList.add('message', 'model-message');
            const status = document.createElement('i');
            status.classList.add('modalstatus');
            status.innerText = SearchOn ? '正在搜索...' : '正在思考...';
            message.appendChild(status);
            messagebox.appendChild(sendinfo);
            messagebox.appendChild(message);
            chatWindow.appendChild(messagebox);

            promptInput.value = '';
            selectedFiles = [];
            renderFilePreviews();
            promptInput.focus();

            promptInput.style.height = '0';
            promptInput.style.height = promptInput.scrollHeight + 'px';

            chatWindow.scrollTop = chatWindow.scrollHeight;

            sendinfobox = sendinfo;
            modelmessage = message;

        }

        function appendStreamChunk(chunk) {
            modelmessage.innerHTML = '';
            if (!currentModelResponseElement) {
                // 如果是流的开始，创建一个新的消息元素
                currentModelResponseElement = modelmessage;
                accumulatedStreamText = '';
            }
            // 将新的原始块附加到累积文本中
            accumulatedStreamText += chunk;
            currentModelResponseElement.innerHTML = marked.parse(accumulatedStreamText);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function appenderror(message) {
            modelmessage.innerText = message;
            modelmessage.style.color = '#d26161';
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        // --- 发送消息 ---
        sendBtn.addEventListener('click', sendMessage);
        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const prompt = promptInput.value.trim();
            if (prompt === '' && selectedFiles.length === 0) return;
            if (sendBtn.disabled) return;

            welcome.style.display = 'none';
            sendBtn.disabled = true;

            const filePromises = selectedFiles.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve({
                            data: e.target.result.split(',')[1], // Base64 data
                            mimeType: file.type
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });

            const files = await Promise.all(filePromises);
            const model = document.getElementById('gemini-v').value;

            socket.emit('newMessage', {
                sessionId,
                prompt,
                files,
                model,
                useWebSearch: SearchOn
            });

        }

        // --- 新建对话 ---
        newChatBtn.addEventListener('click', () => {
            sessionId = null;
            localStorage.removeItem('sessionId');
            chatWindow.innerHTML = '';
            generateUserMessageIndex();
            welcome.style.display = 'block';
            document.querySelectorAll('#history-list li').forEach(el => el.classList.remove('active'));
        });
    </script>
    <script src="script.js"></script>
    <script src="theme.js"></script>

    <!-- 预加载 -->
    <div style="display: none;">
        <img src="img/cbl-2.png" alt="">
    </div>
</body>

</html>